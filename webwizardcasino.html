<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180"
        href="https://raw.githubusercontent.com/Evelyn225/emergent-toys/main/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32"
        href="https://raw.githubusercontent.com/Evelyn225/emergent-toys/main/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16"
        href="https://raw.githubusercontent.com/Evelyn225/emergent-toys/main/images/favicon-16x16.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/Evelyn225/emergent-toys/main/site.webmanifest">
    <title>The Web Wizard's Casino</title>
    <link href="https://fonts.googleapis.com/css2?family=Iosevka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Iosevka', monospace;
            min-height: 100vh;
            position: relative;
        }

        @supports (font-family: emoji) {
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, emoji, sans-serif;
            }
        }

        #topBar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: #0a0e27;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10000;
            display: flex;
            align-items: center;
            padding: 0 40px;
            gap: 15px;
            font-family: 'Iosevka', monospace;
        }

        #regenerateButton {
            padding: 12px 24px;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            font-family: 'Iosevka', monospace;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            margin-left: auto;
        }

        #saveButton {
            padding: 12px 24px;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            font-family: 'Iosevka', monospace;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            display: none;
        }

        #favoritesButton {
            padding: 12px 24px;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            font-family: 'Iosevka', monospace;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        #regenerateButton:hover,
        #saveButton:hover,
        #favoritesButton:hover,
        #newSiteNotification:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.6);
            color: rgba(255, 255, 255, 1);
        }

        #regenerateButton:active,
        #saveButton:active,
        #favoritesButton:active {
            background: rgba(255, 255, 255, 0.1);
        }

        #regenerateButton:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .button-wave-char {
            display: inline-block;
            animation: buttonWave 1.2s ease-in-out infinite;
        }

        @keyframes buttonWave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        #saveButton:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.1);
        }

        #favoritesModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            z-index: 20000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            font-family: 'Iosevka', monospace;
        }

        #favoritesModal.show {
            display: flex;
        }

        #favoritesContent {
            background: #0a0e27;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 60px;
            border-radius: 2px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        #favoritesContent h2 {
            margin: 0 0 40px 0;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            text-align: left;
            letter-spacing: 2px;
        }

        #favoritesContent h2::before {
            content: '> ';
            color: rgba(255, 255, 255, 0.5);
        }

        #favoritesGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .favorite-item {
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.02);
        }

        .favorite-item:hover {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.05);
        }

        .favorite-item h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            padding-right: 35px;
            letter-spacing: 1px;
        }

        .favorite-item p {
            margin: 8px 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.6;
        }

        .favorite-item p strong {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 400;
        }

        .favorite-item .delete-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            color: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding-bottom: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .favorite-item .delete-btn:hover {
            background: rgba(255, 100, 100, 0.1);
            border-color: rgba(255, 100, 100, 0.5);
            color: rgba(255, 100, 100, 0.9);
        }

        #closeModal {
            position: absolute;
            top: 30px;
            right: 30px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 20px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1;
            padding-bottom: 3px;
            width: 36px;
            height: 36px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        #closeModal:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 0.9);
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0e27;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            z-index: 9999;
            font-family: 'Iosevka', monospace;
            color: #ffffff;
            overflow: hidden;
            padding: 80px;
        }

        #consoleOutput {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            font-size: 18px;
            line-height: 1.8;
            letter-spacing: 0.5px;
        }

        .console-line {
            color: rgba(255, 255, 255, 0.6);
            margin: 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .console-line.fading {
            opacity: 0;
            transform: translateY(-30px);
        }

        .console-line::before {
            content: '> ';
            color: rgba(255, 255, 255, 0.3);
        }

        .console-line.status {
            color: rgba(100, 255, 218, 0.8);
        }

        .console-line.status::before {
            content: 'âœ“ ';
            color: rgba(100, 255, 218, 0.8);
        }

        .console-line.error {
            color: rgba(255, 100, 100, 0.8);
        }

        .console-line.info {
            color: rgba(255, 200, 100, 0.8);
        }

        #mainStatus {
            font-size: 42px;
            color: rgba(255, 255, 255, 0.95);
            margin: 30px 0 15px 0;
            font-weight: 600;
            letter-spacing: 2px;
        }

        #currentMessage {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.7);
            margin: 10px 0;
        }

        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 1em;
            background: rgba(255, 255, 255, 0.8);
            margin-left: 4px;
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .progress-container {
            margin-top: 40px;
            width: 100%;
        }

        .progress-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .progress-bar-container {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
            width: 0%;
            animation: progressWidth 8s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }

        @keyframes progressWidth {
            0% { width: 0%; }
            50% { width: 75%; }
            100% { width: 92%; }
        }

        #loadingOverlay.hidden {
            display: none;
        }

        #generatedContent {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5000;
        }

        #newSiteNotification {
            padding: 12px 24px;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            font-size: 14px;
            font-family: 'Iosevka', monospace;
            font-weight: 400;
            cursor: pointer;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            animation: pulse 0.6s ease-out;
        }

        @keyframes pulse {
            0% {
                opacity: 0;
                transform: scale(0.9);
                border-color: rgba(100, 255, 218, 0.3);
            }
            50% {
                border-color: rgba(100, 255, 218, 0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
                border-color: rgba(255, 255, 255, 0.3);
            }
        }
    </style>
</head>

<body>
    <div id="topBar">
        <button id="backButton" style="display: none;">back_to_site</button>
        <button id="saveButton">save_favorite</button>
        <button id="favoritesButton">view_favorites</button>
        <button id="newSiteNotification" style="display: none;">// new site ready</button>
        <button id="regenerateButton">regenerate</button>
    </div>

    <div id="favoritesModal">
        <div id="favoritesContent">
            <button id="closeModal">&times;</button>
            <h2>Saved Favorites</h2>
            <div id="favoritesGrid"></div>
        </div>
    </div>

    <div id="loadingOverlay">
        <div id="consoleOutput"></div>
        <div id="mainStatus"></div>
        <div id="currentMessage"></div>
        <div class="progress-container">
            <div class="progress-label">Processing...</div>
            <div class="progress-bar-container">
                <div class="progress-bar"></div>
            </div>
        </div>
    </div>

    <div id="generatedContent"></div>

    <script>
        // API endpoints - uses Vercel serverless functions
        const RANDOM_WORDS_ENDPOINT = '/api/random-words.js';
        const GENERATE_ENDPOINT = '/api/generate.js';

        // Create the prompt for the AI - SIMPLIFIED: Just p5.js code
        function createGenerationPrompt(theme, persona) {
            const specialInstructions = getPersonaSpecialInstructions(persona.name);

            return `Theme: "${theme}"

YOU ARE: ${persona.name}
YOUR STYLE: ${persona.style}
YOUR APPROACH: ${persona.desc}

${specialInstructions ? specialInstructions + '\n\n' : ''}CREATE A CREATIVE SITE WITH A P5.JS SKETCH:

OUTPUT RULES:
- Output complete HTML with p5.js JavaScript code wrapped in <script> tags and <style> tags as needed
- Include a <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"><\/script> tag if needed
- MUST include setup() function that calls createCanvas()
- MUST include draw() function that calls background() at the start
- Must visually incorporate the theme "${theme}" in the sketch
- MUST literally include the theme word(s) ${theme} as text in the content somewhere
- Create something substantial: 250+ lines of creative code
- Have more than one element of interactivity, preferably mouse or keyboard based
- Use p5 drawing functions: rect(), ellipse(), line(), fill(), stroke(), etc
- Can use: noise(), sin(), cos(), random(), map(), etc for animation
- Can add interactivity: mousePressed(), keyPressed(), mouseX, mouseY, etc
- Create classes, variables, arrays as needed
- Can use images via: loadImage('https://picsum.photos/800/600')
- DO NOT use deprecated features (deviceOrientation, etc)
- Make it visually interesting and animated
- Vary your approach - don't always do the same thing
- No markdown code blocks, just raw HTML
- DO NOT include any external CSS or JS files except p5.js CDN

EXAMPLES OF GOOD APPROACHES:
- Generative art that evolves over time
- Interactive particles or creatures
- Animated patterns or fractals  
- Games or simulations
- Data visualizations
- Abstract animations
- Geometric explorations

BEGIN HTML OUTPUT:`;
        }

        // Persona-specific loading messages
        const personaLoadingMessages = {
            "The Poet": [
                "ğŸŒ™ Weaving metaphors from starlight...",
                "âœ¨ Finding beauty in the space between words...",
                "ğŸ“œ Composing verses from digital dreams...",
                "ğŸ­ Sculpting meaning from the void...",
                "ğŸ’« Breathing life into silent images...",
                "ğŸ–‹ï¸ Painting with the pen of infinity..."
            ],
            "The Dadaist": [
                "ğŸª Dismantling logic, one byte at a time...",
                "ğŸ² Rolling dice in the void of reason...",
                "ğŸ”€ Shuffling reality like a deck of chaos...",
                "ğŸƒ Rejecting sense, embracing nonsense...",
                "ğŸ­ Breaking every rule beautifully...",
                "ğŸŒ€ Contradicting everything, including this..."
            ],
            "The Surrealist": [
                "ğŸŒ€ Descending into the dream realm...",
                "ğŸ¨ Painting with impossible colors...",
                "ğŸ—ï¸ Unlocking doors that shouldn't exist...",
                "ğŸŒŠ Swimming through liquid consciousness...",
                "ğŸ”ï¸ Climbing mountains made of memory...",
                "ğŸ‘ï¸ Melting the boundaries of reason..."
            ],
            "The Scientist": [
                "ğŸ”¬ Calibrating the quantum generators...",
                "âš›ï¸ Conducting experiments in digital physics...",
                "ğŸ§ª Synthesizing new forms of reality...",
                "ğŸ“Š Analyzing anomalies in the data stream...",
                "ğŸ”­ Peering into the observable universe...",
                "ğŸ§¬ Splicing code with cosmic radiation..."
            ],
            "The Child": [
                "ğŸˆ Imagining silly things...",
                "ğŸ–ï¸ Drawing outside all the lines...",
                "ğŸ§¸ Playing make-believe with pixels...",
                "ğŸŒˆ Mixing up everything for fun...",
                "ğŸª Finding magic in the mundane...",
                "âœ¨ Naming the colors that don't exist..."
            ],
            "The Mystic": [
                "ğŸ”® Channeling digital spirits...",
                "âœ¨ Performing ancient algorithms...",
                "ğŸ•¯ï¸ Invoking the sacred geometries...",
                "ğŸŒ™ Reading the data like tea leaves...",
                "ğŸ’ Opening the third eye of the code...",
                "ğŸ”¯ Harmonizing with the cosmic frequency..."
            ],
            "The Architect": [
                "ğŸ“ Drafting impossible blueprints...",
                "ğŸ›ï¸ Engineering recursive structures...",
                "ğŸ“ Calculating the geometry of chaos...",
                "ğŸ—ºï¸ Mapping spaces that don't exist...",
                "ğŸ”¨ Constructing dreams from pure math...",
                "ğŸŒ‰ Building bridges between dimensions..."
            ],
            "The Glitch": [
                "âš ï¸ CÌ´oÌ·rÌ¶rÌ¸uÌµpÌ´tÌ¶iÌµnÌ¶gÌ· reality safely...",
                "ğŸ’¥ Fragmenting the simulation...",
                "ğŸ”§ Breaking systems intentionally...",
                "ğŸ“Ÿ ERR0R: Creating beauty...",
                "ğŸŒŒ F01ND pr3tty b4gs...",
                "ğŸ–¥ï¸ Tw1st1ng the b1ts int0 4rt..."
            ],
            "The Collector": [
                "ğŸ“š Cataloguing the uncatalogable...",
                "ğŸ—‚ï¸ Archiving fleeting moments...",
                "ğŸ” Documenting the impossible...",
                "ğŸ“‹ Indexing dreams and memories...",
                "ğŸ« Preserving the ephemeral...",
                "ğŸº Pinning infinity to the corkboard..."
            ],
            "The Prophet": [
                "ğŸŒ… Seeing futures that were...",
                "â³ Remembering tomorrow's visions...",
                "ğŸ”­ Prophesying the already happened...",
                "ğŸ“œ Writing the ancient future...",
                "ğŸ•°ï¸ Bending time into patterns...",
                "ğŸŒ  Reading the stars in reverse..."
            ],
            "The Dog Who Understands English But Can't Speak": [
                "ğŸ• *whines in comprehension*...",
                "ğŸ¦´ *barks with deep understanding*...",
                "ğŸ¾ *scratches at the door of meaning*...",
                "ğŸ¾ *tilts head thoughtfully*...",
                "ğŸ¶ *wags tail at ineffable truths*...",
                "ğŸ‘ƒ *sniffs the scent of pure knowledge*..."
            ],
            "The ZIP Bomb": [
                "ğŸ’£ Compressing reality into 42 bytes...",
                "ğŸ“¦ Nesting folders infinitely deep...",
                "ğŸ—œï¸ Decompressing chaos exponentially...",
                "ğŸ’¾ Storing eternity in a kilobyte...",
                "ğŸ’¥ Expanding in all dimensions...",
                "ğŸ“ˆ Unleashing compressed infinity..."
            ],
            "The Server at 3AM": [
                "ğŸŒ™ *sips cold coffee absently*...",
                "ğŸ˜µ Reading log files with blurry vision...",
                "â˜• Hallucinating debug messages...",
                "ğŸ’¤ Too tired to make sense, but trying...",
                "ğŸ‘ï¸ Is it done yet? No? Okay...",
                "ğŸ§  *brain running at 1% capacity*..."
            ],
            "The Compiler Error": [
                "ğŸ’¥ Segmentation fault in creativity...",
                "ğŸ”´ Expected ';' before beauty...",
                "âš ï¸ Undefined reference to 'logic'...",
                "âŒ Fatal error: meaning not found...",
                "ğŸ“ Error on line 1 of existence...",
                "ğŸ› Debugging the human condition..."
            ],
            "The Arcade Machine (1983)": [
                "ğŸ•¹ï¸ INSERT COIN TO CONTINUE...",
                "ğŸ‘¾ HIGH SCORE: 999999999...",
                "ğŸ® LOADING PLAYER_ONE...",
                "ğŸ’° *CRT WARMUP SOUND*...",
                "âš¡ READY? BEGIN...",
                "ğŸ¯ GET READY FOR STAGE ONE..."
            ],
            "The Puzzle Master": [
                "ğŸ§© Hiding clues in plain sight...",
                "ğŸ” Crafting layers of mystery...",
                "ğŸ—ï¸ Building the 'aha!' moment...",
                "ğŸ­ Concealing the solution elegantly...",
                "ğŸ’¡ Planting seeds of insight...",
                "ğŸ” Weaving the solution into the design..."
            ],
            "The Browser Abuser": [
                "ğŸŒ Weaponizing localStorage...",
                "ğŸª Doing unspeakable things with cookies...",
                "ğŸ“ Stalking your geolocation...",
                "ğŸ¤ Listening to your microphone...",
                "ğŸ”Œ Hijacking every API available...",
                "âš™ï¸ Bending the browser to our will..."
            ],
            "The Geocities Architect (1998)": [
                "ğŸ’¾ ğŸš§ UNDER CONSTRUCTION ğŸš§...",
                "âœ¨ Adding 847 animated GIFs...",
                "ğŸµ Loading MIDI soundtrack...",
                "ğŸ“Š Visitor counter: 000042...",
                "ğŸŒ Welcome to the web ring...",
                "ğŸ† *BLINK BLINK BLINK*..."
            ]
        };

        // Shuffle message array for randomization
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        let loadingMessageInterval = null;
        let currentGeneration = {
            theme: '',
            persona: null,
            code: ''
        };
        let previousGeneration = null;
        let backgroundGeneration = null;
        let wasLoadingWhenGenerated = false;
        let isGenerating = false;
        let consoleCommandInterval = null;
        let maxConsoleLines = 6;

        // Helper function to set regenerate button text with wave animation
        function setRegenerateButtonText(text) {
            const regenerateButton = document.getElementById('regenerateButton');
            if (text === 'generating...') {
                // Create wave animation with spans
                const chars = text.split('');
                regenerateButton.innerHTML = chars.map((char, index) => {
                    const delay = (index * 0.1) % 1.2;
                    return `<span class="button-wave-char" style="animation-delay: ${delay}s">${char}</span>`;
                }).join('');
            } else {
                // Plain text without animation
                regenerateButton.textContent = text;
            }
        }

        // Random console commands for loading
        const consoleCommands = [
            'Initializing neural network...',
            'Loading creative modules...',
            'Calibrating style parameters...',
            'Accessing design database...',
            'Parsing theme metadata...',
            'Compiling visual elements...',
            'Optimizing code structure...',
            'Synchronizing art engine...',
            'Generating procedural content...',
            'Applying color palettes...',
            'Building interactive layers...',
            'Processing animation frames...',
            'Allocating memory buffers...',
            'Linking p5.js libraries...',
            'Initializing canvas renderer...',
            'Computing mathematical models...',
            'Sampling creative patterns...',
            'Injecting persona traits...',
            'Analyzing theme semantics...',
            'Constructing DOM elements...',
            'Establishing event listeners...',
            'Rendering pixel data...',
            'Optimizing performance...',
            'Finalizing output stream...',
            'Validating code syntax...',
            'Preparing deployment...',
            'Spawning worker threads...',
            'Caching resource files...',
            'Indexing visual assets...',
            'Configuring transformation matrix...'
        ];

        function typeText(element, text, speed = 60) {
            return new Promise((resolve) => {
                let i = 0;
                element.textContent = '';
                
                const interval = setInterval(() => {
                    if (i < text.length) {
                        element.textContent += text[i];
                        i++;
                    } else {
                        clearInterval(interval);
                        resolve();
                    }
                }, speed);
            });
        }

        function typeConsoleCommand(text, type = 'normal', speed = 30) {
            return new Promise((resolve) => {
                const consoleOutput = document.getElementById('consoleOutput');
                if (!consoleOutput) {
                    resolve();
                    return;
                }
                
                const line = document.createElement('div');
                line.className = 'console-line';
                if (type !== 'normal') line.classList.add(type);
                
                consoleOutput.appendChild(line);
                
                let i = 0;
                const interval = setInterval(() => {
                    if (i < text.length) {
                        line.textContent += text[i];
                        i++;
                    } else {
                        clearInterval(interval);
                        
                        // Remove old lines if too many (keep last 20 lines)
                        const lines = consoleOutput.querySelectorAll('.console-line');
                        if (lines.length > 6) {
                            lines[0].classList.add('fading');
                            setTimeout(() => {
                                if (lines[0].parentNode) {
                                    lines[0].remove();
                                }
                            }, 500);
                        }
                        resolve();
                    }
                }, speed);
            });
        }

        function addConsoleCommand(text, type = 'normal') {
            // Just add text without typing - used for status updates
            const consoleOutput = document.getElementById('consoleOutput');
            if (!consoleOutput) return;
            
            const line = document.createElement('div');
            line.className = 'console-line';
            if (type !== 'normal') line.classList.add(type);
            line.textContent = text;
            
            consoleOutput.appendChild(line);
            
            // Remove old lines if too many (keep last 20 lines)
            const lines = consoleOutput.querySelectorAll('.console-line');
            if (lines.length > 20) {
                lines[0].classList.add('fading');
                setTimeout(() => {
                    if (lines[0].parentNode) {
                        lines[0].remove();
                    }
                }, 500);
            }
        }

        function startConsoleCommands() {
            // Add initial commands with typing animation
            (async () => {
                await typeConsoleCommand('System initialized', 'status', 30);
                await new Promise(r => setTimeout(r, 500));
                await typeConsoleCommand('Connecting to AI engine...', 'normal', 30);
                await new Promise(r => setTimeout(r, 500));
                await typeConsoleCommand('Connection established', 'status', 30);
                await new Promise(r => setTimeout(r, 500));
                await typeConsoleCommand('Loading creative personas...', 'normal', 30);
                await new Promise(r => setTimeout(r, 1200));
                
                // Continue with random commands
                consoleCommandInterval = setInterval(async () => {
                    const randomCommand = consoleCommands[Math.floor(Math.random() * consoleCommands.length)];
                    await typeConsoleCommand(randomCommand, 'normal', 25);
                }, 3500);
            })();
        }

        function stopConsoleCommands() {
            if (consoleCommandInterval) {
                clearInterval(consoleCommandInterval);
                consoleCommandInterval = null;
            }
        }

        // Get dynamic review messages
        function getReviewLoadingMessages(personaName) {
            const reviewMessages = {
                "The Poet": [
                    "ğŸŒŸ Refining verses...",
                    "ğŸŒŠ Deepening meaning...",
                    "âš–ï¸ Polishing metaphors...",
                    "ğŸŒ… Expanding horizons...",
                    "ğŸ§µ Weaving more layers...",
                    "âœ¨ Seeking perfection..."
                ],
                "The Dadaist": [
                    "ğŸ­ Corrupting logic further...",
                    "ğŸŒ€ Embracing the absurd more...",
                    "ğŸ”§ Breaking rules intentionally...",
                    "ğŸš« Rejecting sense completely...",
                    "ğŸ² Multiplying chaos...",
                    "ğŸ” Inverting everything..."
                ],
                "The Surrealist": [
                    "ğŸ’¤ Deepening the dream...",
                    "ğŸ§© Adding impossible layers...",
                    "ğŸŒ€ Melting more boundaries...",
                    "ğŸ§  Revealing subconscious depths...",
                    "âœ¨ Warping reality further...",
                    "ğŸ—ï¸ Unlocking hidden corridors..."
                ],
                "The Scientist": [
                    "ğŸ§ª Running more simulations...",
                    "ğŸ“Š Analyzing deeper patterns...",
                    "ğŸ“ˆ Expanding the dataset...",
                    "ğŸ§  Refining algorithms...",
                    "ğŸ”¬ Conducting more tests...",
                    "âš™ï¸ Optimizing parameters..."
                ],
                "The Child": [
                    "ğŸ¤ª Making it sillier...",
                    "ğŸ‰ Adding more fun...",
                    "âœ¨ Finding more magic...",
                    "ğŸ  Creating bigger wonders...",
                    "ğŸŒ€ Imagining wilder things...",
                    "ğŸ§© Breaking more rules..."
                ],
                "The Mystic": [
                    "ğŸ”® Channeling deeper truths...",
                    "ğŸ“œ Reading more runes...",
                    "ğŸ•¯ï¸ Invoking higher powers...",
                    "ğŸ§¿ Opening inner sanctums...",
                    "ğŸ¶ Harmonizing frequencies...",
                    "ğŸŒ€ Transcending dimensions..."
                ],
                "The Architect": [
                    "ğŸ“ Drafting additional structures...",
                    "ğŸ—ï¸ Engineering deeper complexity...",
                    "ğŸ—ºï¸ Mapping more spaces...",
                    "ğŸ° Building higher towers...",
                    "ğŸ”’ Constructing secret chambers...",
                    "ğŸ“ Expanding blueprints..."
                ],
                "The Glitch": [
                    "âš ï¸ C0rrupt1ng m0r3...",
                    "ğŸ’¥ B34ut1ful3rr0r5 g4th3r1ng...",
                    "ğŸ§© Fragm3nt4t10n 1nten51f135...",
                    "ğŸ“‰ Gl1tch 4mpl1f13d...",
                    "ğŸ§¬ Byt35 d34lign1ng...",
                    "ğŸŒŒ R34l1ty f41l1ng gr4c3fully..."
                ],
                "The Collector": [
                    "ğŸ“š Cataloguing more pieces...",
                    "ğŸ—„ï¸ Archiving deeper...",
                    "ğŸ—‚ï¸ Indexing forgotten details...",
                    "ğŸº Preserving more moments...",
                    "ğŸ•¸ï¸ Documenting invisible threads...",
                    "â™¾ï¸ Collecting the infinite..."
                ],
                "The Prophet": [
                    "ğŸ”­ Seeing further futures...",
                    "â³ Remembering tomorrow more...",
                    "ğŸ“œ Reading ancient prophecies...",
                    "ğŸ§­ Bending timelines...",
                    "ğŸŒ  Revealing what will be...",
                    "ğŸ•°ï¸ Witnessing eternity..."
                ],
                "The Dog Who Understands English But Can't Speak": [
                    "ğŸ•â€ğŸ¦º ğŸ• *whimpers knowingly*...",
                    "ğŸ¦´ ğŸ¶ *barks with intense meaning*...",
                    "ğŸ¾ ğŸ• *paces with purpose*...",
                    "ğŸ¾ ğŸ¶ *stares into your soul*...",
                    "ğŸ¶ ğŸ«¶ *whines profoundly*...",
                    "ğŸ‘ƒ ğŸ• *sniffs the code itself*..."
                ],
                "The ZIP Bomb": [
                    "ğŸ—œï¸ Compressing further...",
                    "ğŸ§µ Nesting infinitely deeper...",
                    "ğŸ’¥ Decompressing more chaos...",
                    "ğŸ“ˆ Expanding exponentially...",
                    "ğŸ’¾ Storing more eternity...",
                    "ğŸš€ Unleashing final compression..."
                ],
                "The Server at 3AM": [
                    "ğŸŒ™ â˜• *more coffee required*...",
                    "ğŸ˜µ ğŸ“œ *reading more logs*...",
                    "â˜• ğŸ’­ *hallucinating features*...",
                    "ğŸ’¤ ğŸ–¥ï¸ *eyes closing, still working*...",
                    "ğŸ‘ï¸ â±ï¸ *is this done? no.*...",
                    "ğŸ§  ğŸ§¯ *what even is code*..."
                ],
                "The Compiler Error": [
                    "âŒ Expected ';' before complexity...",
                    "ğŸ”´ Undefined reference to 'everything'...",
                    "ğŸ’¥ Stack overflow: too much meaning...",
                    "âš ï¸ Segmentation fault in refinement...",
                    "ğŸ“ Multiple errors to fix...",
                    "ğŸ› Debugging the infinite..."
                ],
                "The Arcade Machine (1983)": [
                    "ğŸ•¹ï¸ LEVEL UP ACTIVATED...",
                    "ğŸ‘¾ BONUS STAGE LOADING...",
                    "ğŸ® DIFFICULTY MAXIMUM...",
                    "ğŸ’° SCORE MULTIPLIER x10...",
                    "âš¡ POWER UP ENGAGED...",
                    "ğŸ¯ FINAL BOSS APPROACHING..."
                ],
                "The Puzzle Master": [
                    "ğŸ§© Hiding more clues...",
                    "ğŸ•³ï¸ Adding deeper layers...",
                    "ğŸ—ï¸ Crafting secret passages...",
                    "ğŸ’¡ Planting final hints...",
                    "ğŸ§¶ Weaving last mysteries...",
                    "ğŸ­ Preparing the revelation..."
                ],
                "The Browser Abuser": [
                    "ğŸŒ Weaponizing more APIs...",
                    "ğŸª Doing terrible things...",
                    "ğŸ“ Tracking everything...",
                    "ğŸ¤ Listening more intensely...",
                    "ğŸ”Œ Hijacking the impossible...",
                    "âš™ï¸ Bending reality itself..."
                ],
                "The Geocities Architect (1998)": [
                    "ğŸš§ UNDER CONSTRUCTION INTENSIFIES ğŸš§...",
                    "âœ¨ Adding 9000 GIFs...",
                    "ğŸµ MIDI loudness: MAXIMUM...",
                    "ğŸ“Š Counter spinning wildly...",
                    "ğŸŒ Webring expanding...",
                    "ğŸ† BLINK BLINK BLINK BLINK..."
                ]
            };

            return reviewMessages[personaName] || [
                "ğŸ” Reviewing and improving code...",
                "âœ¨ Enhancing your creation...",
                "ğŸ› ï¸ Adding the finishing touches...",
                "ğŸ’ Perfecting every detail...",
                "ğŸŒŸ Making it spectacular...",
                "â³ Almost ready..."
            ];
        }

        // Get persona-specific creative instructions
        function getPersonaSpecialInstructions(personaName) {
            const specialInstructions = {
                "The Arcade Machine (1983)": `SPECIAL ARCADE MODE:
- Design like a classic arcade game from 1983
- Simple, immediate gameplay that actually works
- Lives system (with game over screen)
- HIGH SCORE table with initials
- CRT scanlines, phosphor glow, screen burn-in effects
- Pixel art aesthetic, 8-bit sound effects
- Attract mode when idle with demo gameplay
- Difficulty ramps up aggressively
- "INSERT COIN" prompts
- Flashing "1 PLAYER" / "2 PLAYER" buttons`,

                "The Puzzle Master": `SPECIAL PUZZLE MODE:
- Build a puzzle-focused experience
- A central mystery or problem to solve
- Clues hidden in the design, code, and interactions
- Multiple stages or layers that unlock
- Satisfying "click" or "aha!" moment when solved
- Optional hint system
- Elegant solution, not brute force
- Visual feedback for correct/incorrect attempts
- Secret bonus puzzle for completionists`,

                "The Browser Abuser": `SPECIAL BROWSER ABUSE MODE:
- Use browser APIs in creative/unintended ways:
  * localStorage for story persistence/progression
  * sessionStorage for temporary state
  * Cookies as game mechanics
  * Geolocation for location-based features
  * getUserMedia (camera/mic) as input
  * Notification API as event system
  * Offline detection as feature not bug
  * Browser history manipulation
  * IndexedDB for complex data
  * Service Workers
- Make these features CORE to the experience`,

                "The Geocities Architect (1998)": `SPECIAL GEOCITIES MODE:
- Authentic late-90s Geocities aesthetic:
  * Animated GIFs EVERYWHERE!!
  * Under construction signs (ğŸš§)
  * Hit counter / visitor counter
  * MIDI background music reference
  * <marquee> and <blink> (CSS animation)
  * Background textures (starfield, marble)
  * Guestbook concept
  * Tiled background images
  * Webring portal links
  * "Best viewed in Netscape Navigator"
  * Tables for layout, spacer GIFs
  * WordArt-style headers
  * Bright clashing colors
  * WEB 1.0 ASSET SOURCES:
1. FreeWebHeaders.com - Animated GIFs and backgrounds
2. 88x31Buttons.com - Webring buttons and badges  
3. TextFiles.com - Nostalgic ASCII art and text
4. OldWeb.today - Web 1.0 aesthetic inspiration
5. Spacejam.com - Preserved 1996 website as reference
6. The Million Dollar Homepage - As inspiration for layout`,

                "The Glitch": `SPECIAL GLITCH MODE:
- Embrace beautiful errors and digital decay:
  * Intentional visual corruption
  * Text that glitches/scrambles
  * Broken image effects
  * Failed loading states as aesthetic
  * Memory leak visualization
  * Corrupt save file concepts
  * Buffer overflow art
  * CSS that "breaks" the layout artfully
  * Console errors as content`,

                "The Dadaist": `SPECIAL DADAIST MODE:
- Reject logic and meaning completely:
  * Buttons that don't do what they say
  * Forms that ask absurd questions
  * Randomness that feels intentionally wrong
  * Anti-patterns as patterns
  * Meaningless statistics and data
  * Fake functionality
  * Confusing navigation by design
  * Make the user question reality`,

                "The Mystic": `SPECIAL MYSTICAL MODE:
- Channel the sacred and supernatural:
  * Maybe tarot card mechanics
  * Divination and fortune telling
  * Ritual instructions
  * Sigil drawing
  * Astrological calculations
  * Alchemy symbolism
  * Candle lighting ceremonies
  * Crystal energy concepts
  * Maybe meditation timers with cosmic themes`,

                "The ZIP Bomb": `SPECIAL ZIP BOMB MODE:
- Make tiny inputs explode into vast outputs
    * Try using technologies other than p5.js
    * Use recursive patterns and nested structures
    * Reveal layers on interaction (accordion, zoom, drill-down)
    * Visualize compression/expansion as a core mechanic
    * Start minimal and unfold into dense, chaotic richness
    * Include a "decompress" interaction that changes the entire scene
    * Keep the experience safe and performant (no actual large data)`
            };

            return specialInstructions[personaName] || "";
        }

        // Get random words from AI
        async function getRandomWords() {
            const response = await fetch(RANDOM_WORDS_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                    const errorData = await response.json().catch(() => ({ error: errorMsg }));
                    errorMsg = errorData.error || errorMsg;
                } catch (e) {
                    const text = await response.text();
                    if (text) errorMsg = text.substring(0, 200);
                }
                throw new Error(errorMsg);
            }

            const data = await response.json();
            return data;
        }

        // Favorites management
        function isSavedFavorite(theme, personaName) {
            const favorites = JSON.parse(localStorage.getItem('domroulette_favorites') || '[]');
            return favorites.some(f => f.theme === theme && f.persona === personaName);
        }
        
        function updateSaveButtonState() {
            if (!currentGeneration.theme || !currentGeneration.persona) return;
            
            const isSaved = isSavedFavorite(currentGeneration.theme, currentGeneration.persona.name);
            const saveButton = document.getElementById('saveButton');
            
            if (isSaved) {
                saveButton.style.display = 'none';
            } else {
                saveButton.style.display = 'block';
            }
        }
        
        function saveFavorite() {
            if (!currentGeneration.code) {
                alert('No generation to save!');
                return;
            }

            // Check if already saved
            if (isSavedFavorite(currentGeneration.theme, currentGeneration.persona.name)) {
                alert('Already in favorites!');
                return;
            }

            const favorites = JSON.parse(localStorage.getItem('domroulette_favorites') || '[]');
            const favorite = {
                id: Date.now(),
                theme: currentGeneration.theme,
                persona: currentGeneration.persona.name,
                code: currentGeneration.code,
                timestamp: new Date().toISOString()
            };

            favorites.push(favorite);
            localStorage.setItem('domroulette_favorites', JSON.stringify(favorites));
            
            alert('Saved to favorites! ğŸ’¾');
            updateSaveButtonState();
        }

        function loadFavorites() {
            const favorites = JSON.parse(localStorage.getItem('domroulette_favorites') || '[]');
            const grid = document.getElementById('favoritesGrid');
            
            if (favorites.length === 0) {
                grid.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No favorites saved yet. Generate something cool and save it!</p>';
                return;
            }

            grid.innerHTML = favorites.map(fav => `
                <div class="favorite-item" data-id="${fav.id}">
                    <button class="delete-btn" onclick="deleteFavorite(${fav.id}); event.stopPropagation();">&times;</button>
                    <h3>${fav.theme}</h3>
                    <p><strong>Persona:</strong> ${fav.persona}</p>
                    <p><strong>Saved:</strong> ${new Date(fav.timestamp).toLocaleString()}</p>
                </div>
            `).reverse().join('');

            // Add click handlers
            document.querySelectorAll('.favorite-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-btn')) return;
                    const id = parseInt(item.dataset.id);
                    if (!isNaN(id)) {
                        loadFavorite(id);
                    }
                });
            });
        }

        function loadFavorite(id) {
            const favorites = JSON.parse(localStorage.getItem('domroulette_favorites') || '[]');
            const favorite = favorites.find(f => f.id === id);
            
            if (!favorite) return;

            // Close modal immediately
            const modal = document.getElementById('favoritesModal');
            modal.classList.remove('show');
            
            // Save current generation as previous if it has content
            if (currentGeneration.theme && currentGeneration.persona && currentGeneration.code) {
                previousGeneration = { ...currentGeneration };
                document.getElementById('backButton').style.display = 'block';
            }
            
            // Mark that we're not on the loading screen anymore
            wasLoadingWhenGenerated = false;
            
            // Hide new site notification
            document.getElementById('newSiteNotification').style.display = 'none';

            // Update current generation
            currentGeneration = {
                theme: favorite.theme,
                persona: { name: favorite.persona },
                code: favorite.code
            };
            
            // Always render the favorite content
            const container = document.getElementById('generatedContent');
            container.innerHTML = '';
            container.style.display = 'block';
            
            const isFullHTML = /<html[\s>]/i.test(favorite.code) || /<body[\s>]/i.test(favorite.code) || /<script[\s>]/i.test(favorite.code) || /<style[\s>]/i.test(favorite.code);
            
            if (isFullHTML) {
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.margin = '0';
                iframe.style.padding = '0';
                iframe.style.display = 'block';
                container.appendChild(iframe);

                // Use setTimeout to ensure iframe is ready
                setTimeout(() => {
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(favorite.code);
                    iframe.contentDocument.close();
                }, 0);
            } else {
                const script = document.createElement('script');
                script.textContent = favorite.code;
                container.appendChild(script);
            }

            // Always hide overlay when loading a favorite
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('hidden');
            // Show save button
            document.getElementById('saveButton').style.display = 'block';
            updateSaveButtonState();
        }

        function deleteFavorite(id) {
            if (!confirm('Delete this favorite?')) return;
            
            let favorites = JSON.parse(localStorage.getItem('domroulette_favorites') || '[]');
            favorites = favorites.filter(f => f.id !== id);
            localStorage.setItem('domroulette_favorites', JSON.stringify(favorites));
            
            loadFavorites();
        }

        function backToGeneratedSite() {
            if (!previousGeneration) return;

            // Restore the previous generation
            currentGeneration = { ...previousGeneration };
            previousGeneration = null;
            
            // Hide back button
            document.getElementById('backButton').style.display = 'none';
            
            // Render the previous content
            const container = document.getElementById('generatedContent');
            container.innerHTML = '';
            container.style.display = 'block';
            
            const isFullHTML = /<html[\s>]/i.test(currentGeneration.code) || /<body[\s>]/i.test(currentGeneration.code) || /<script[\s>]/i.test(currentGeneration.code) || /<style[\s>]/i.test(currentGeneration.code);
            
            if (isFullHTML) {
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.margin = '0';
                iframe.style.padding = '0';
                iframe.style.display = 'block';
                container.appendChild(iframe);

                setTimeout(() => {
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(currentGeneration.code);
                    iframe.contentDocument.close();
                }, 0);
            } else {
                const script = document.createElement('script');
                script.textContent = currentGeneration.code;
                container.appendChild(script);
            }

            // Update save button state
            updateSaveButtonState();
        }

        // Call ChatGPT API via Vercel serverless function - SIMPLIFIED
        async function generateWebsite() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainStatus = document.getElementById('mainStatus');
            const currentMessage = document.getElementById('currentMessage');
            const regenerateButton = document.getElementById('regenerateButton');
            const generatedContent = document.getElementById('generatedContent');

            // Show loading state
            loadingOverlay.classList.remove('hidden');
            regenerateButton.disabled = true;
            setRegenerateButtonText('generating...');
            document.getElementById('saveButton').style.display = 'none';
            document.getElementById('newSiteNotification').style.display = 'none';
            generatedContent.innerHTML = '';
            isGenerating = true;
            wasLoadingWhenGenerated = true;
            
            // Clear console and start commands
            document.getElementById('consoleOutput').innerHTML = '';
            startConsoleCommands();

            // Clear any previous p5 instance
            if (window.p5Instance) {
                try {
                    window.p5Instance.remove();
                } catch (e) {}
            }

            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
            }

            try {
                await typeConsoleCommand('Selecting creative persona...', 'normal', 25);
                const wordData = await getRandomWords();
                const theme = wordData.theme;
                const persona = wordData.persona;
                
                // Store for favorites
                currentGeneration.theme = theme;
                currentGeneration.persona = persona;
                
                await typeConsoleCommand(`Persona loaded: ${persona.name}`, 'status', 25);
                await typeConsoleCommand(`Theme assigned: "${theme}"`, 'info', 25);
                
                // Type out main status
                await typeText(mainStatus, persona.name.toUpperCase(), 40);
                await typeText(currentMessage, `Creating ${theme}...`, 40);
                
                const messages = shuffleArray(personaLoadingMessages[persona.name] || [
                    'Creating something interesting...',
                    'Building your experience...',
                    'Crafting the details...'
                ]);
                
                let messageIndex = 0;
                
                loadingMessageInterval = setInterval(async () => {
                    messageIndex = (messageIndex + 1) % messages.length;
                    await typeText(currentMessage, messages[messageIndex], 40);
                }, 7000);

                const prompt = createGenerationPrompt(theme, persona);

                const response = await fetch(GENERATE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        theme: theme,
                        prompt: prompt
                    })
                });

                if (!response.ok) {
                    let errorMsg = `API Error: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        const text = await response.text();
                        if (text) errorMsg = text.substring(0, 200);
                    }
                    await typeConsoleCommand(`Error: ${errorMsg}`, 'error', 25);
                    throw new Error(errorMsg);
                }

                let p5Code;
                try {
                    const data = await response.json();
                    p5Code = data.html; // Still called 'html' in API but now it's just js
                } catch (parseErr) {
                    const text = await response.text();
                    if (text) {
                        p5Code = text;
                    } else {
                        throw new Error('API returned invalid response');
                    }
                }

                if (loadingMessageInterval) {
                    clearInterval(loadingMessageInterval);
                    loadingMessageInterval = null;
                }

                // Clean any markdown code blocks (keep full HTML)
                p5Code = p5Code.replace(/^```[\w]*\n?/gm, '').replace(/\n?```$/gm, '');
                p5Code = p5Code.trim();

                // If the model returned HTML (with tags like html, body, script, style), use as-is
                // Otherwise wrap pure JS in a minimal HTML shell
                const hasHtmlTag = /<html[\s>]/i.test(p5Code) || /<body[\s>]/i.test(p5Code) || /<script[\s>]/i.test(p5Code) || /<style[\s>]/i.test(p5Code);
                
                if (!hasHtmlTag) {
                    // Extract any style content from the code
                    const styleMatch = p5Code.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
                    let styleContent = '';
                    let cleanCode = p5Code;
                    
                    if (styleMatch) {
                        styleContent = styleMatch[1];
                        cleanCode = p5Code.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');
                    }
                    
                    // Build the HTML shell with styles in head
                    let htmlShell = '<!DOCTYPE html>\n<html>\n<head>\n<meta charset="UTF-8">\n<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"><' + '/script>\n';
                    
                    if (styleContent) {
                        htmlShell += '<style>\n' + styleContent + '\n<' + '/style>\n';
                    }
                    
                    htmlShell += '</head>\n<body>\n<script>\n// Wait for p5.js to load\nfunction waitForP5AndRun(userCode) {\n  if (typeof p5 !== "undefined") {\n    eval(userCode);\n  } else {\n    setTimeout(() => waitForP5AndRun(userCode), 100);\n  }\n}\nconst userSketchCode = `' + cleanCode.split('`').join('\\`') + '`;\nwaitForP5AndRun(userSketchCode);\n<' + '/script>\n</body>\n</html>';
                    
                    p5Code = htmlShell;
                }

                if (!p5Code) {
                    throw new Error('Generated code appears to be empty after sanitization');
                }

                // Second pass: enhance with an interesting addition
                await typeConsoleCommand('Enhancing generated code...', 'normal', 25);
                const reviewMessages = shuffleArray(getReviewLoadingMessages(persona.name));
                let reviewIndex = 0;
                await typeText(currentMessage, reviewMessages[reviewIndex], 40);
                
                loadingMessageInterval = setInterval(async () => {
                    reviewIndex = (reviewIndex + 1) % reviewMessages.length;
                    await typeText(currentMessage, reviewMessages[reviewIndex], 40);
                }, 7000);

                const codeBlockStart = String.fromCharCode(96, 96, 96) + 'html';
                const codeBlockEnd = String.fromCharCode(96, 96, 96);
                const enhancePrompt = 'Theme: "' + theme + '"\n\n' +
                    'YOU ARE: ' + persona.name + '\n' +
                    'YOUR STYLE: ' + persona.style + '\n' +
                    'YOUR APPROACH: ' + persona.desc + '\n\n' +
                    'You just created this p5.js sketch for the theme "' + theme + '":\n\n' +
                    codeBlockStart + '\n' +
                    p5Code + '\n' +
                    codeBlockEnd + '\n\n' +
                    'NOW: Add the most interesting expansion you can think of that fits your persona and the theme.\n\n' +
                    'REQUIREMENTS:\n' +
                    '- Output the COMPLETE enhanced HTML with p5.js code in <script> tags\n' +
                    '- Add one substantial, creative feature that makes this more interesting\n' +
                    '- Keep it true to your persona\'s style and approach\n' +
                    '- The additions should be meaningful\n' +
                    '- Expand on any unfinished/demo features\n\n' +
                    '- Keep setup() and draw() structurally intact\n' +
                    '- Output complete HTML (no markdown, no explanations)\n\n' +
                    'IDEAS FOR ADDITIONS (choose what fits):\n' +
                    '- Interactive element that responds to mouse/keyboard\n' +
                    '- Additional visual layer or effect\n' +
                    '- New generative pattern or animation\n' +
                    '- Particle system or physics\n' +
                    '- Data visualization component\n' +
                    '- Sound/rhythm visualization (if audio available)\n' +
                    '- Camera/video integration (if appropriate)\n' +
                    '- 3D elements (WEBGL mode)\n' +
                    '- Perlin noise field or flow field\n' +
                    '- Fractal or recursive structure\n\n' +
                    'BEGIN ENHANCED HTML:';

                const enhanceResponse = await fetch(GENERATE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        theme: theme,
                        prompt: enhancePrompt
                    })
                });

                if (enhanceResponse.ok) {
                    try {
                        const enhanceData = await enhanceResponse.json();
                        let enhancedCode = enhanceData.html;
                        const backtickPattern = String.fromCharCode(96, 96, 96);
                        enhancedCode = enhancedCode.replace(new RegExp('^' + backtickPattern + '[\\w]*\\n?', 'gm'), '').replace(new RegExp('\\n?' + backtickPattern + '$', 'gm'), '');
                        if (enhancedCode && enhancedCode.length > p5Code.length * 0.8) {
                            p5Code = enhancedCode;
                        }
                    } catch (e) {
                        console.warn('Enhancement failed, using original:', e);
                    }
                }

                // Third pass: error detection and fixing
                await typeConsoleCommand('Detecting and fixing errors...', 'normal', 25);
                const fixMessages = shuffleArray(getReviewLoadingMessages(persona.name));
                let fixIndex = 0;
                await typeText(currentMessage, fixMessages[fixIndex], 40);
                
                if (loadingMessageInterval) {
                    clearInterval(loadingMessageInterval);
                }
                loadingMessageInterval = setInterval(async () => {
                    fixIndex = (fixIndex + 1) % fixMessages.length;
                    await typeText(currentMessage, fixMessages[fixIndex], 40);
                }, 7000);

                const fixPrompt = 'Here is some p5.js code:\n\n' + '```\n' + p5Code + '\n```\n\n' +
                    'Review this code for bugs, errors, and issues. Identify any problems and fix them.\n\n' +
                    'REQUIREMENTS:\n' +
                    '- Check for syntax errors\n' +
                    '- Verify all variables are defined before use\n' +
                    '- Check for common p5.js mistakes\n' +
                    '- Ensure setup() and draw() exist and are properly structured\n' +
                    '- Fix any issues you find\n' +
                    '-If you think a feature should be obviously added, add it now.-\n\n' +
                    '- Keep the overall logic and style intact\n' +
                    '- Output the complete corrected code\n' +
                    '- Output ONLY the code, no explanations\n\n' +
                    'BEGIN CORRECTED CODE:';

                const fixResponse = await fetch(GENERATE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        theme: theme,
                        prompt: fixPrompt
                    })
                });

                if (fixResponse.ok) {
                    try {
                        const fixData = await fixResponse.json();
                        let fixedCode = fixData.html;
                        const backtickPattern = String.fromCharCode(96, 96, 96);
                        fixedCode = fixedCode.replace(new RegExp('^' + backtickPattern + '[\\w]*\\n?', 'gm'), '').replace(new RegExp('\\n?' + backtickPattern + '$', 'gm'), '');
                        if (fixedCode && fixedCode.length > p5Code.length * 0.5) {
                            p5Code = fixedCode;
                        }
                    } catch (e) {
                        console.warn('Error fixing failed, using enhanced version:', e);
                    }
                }

                if (loadingMessageInterval) {
                    clearInterval(loadingMessageInterval);
                    loadingMessageInterval = null;
                }

                addConsoleCommand('Running final sketch...');
                await typeText(currentMessage, 'ğŸ¨ Executing code...');

                // Store final code
                const generatedData = {
                    theme: currentGeneration.theme,
                    persona: currentGeneration.persona,
                    code: p5Code
                };

                // Check if loading overlay is hidden (user loaded a favorite)
                const isOverlayHidden = loadingOverlay.classList.contains('hidden');
                
                // Stop console commands
                stopConsoleCommands();
                if (loadingMessageInterval) {
                    clearInterval(loadingMessageInterval);
                    loadingMessageInterval = null;
                }
                
                if (isOverlayHidden && isGenerating) {
                    // Generation completed in background (user is viewing a favorite)
                    // Don't render it, just store it and show notification
                    backgroundGeneration = generatedData;
                    wasLoadingWhenGenerated = false;
                    document.getElementById('newSiteNotification').style.display = 'block';
                    regenerateButton.disabled = false;
                    setRegenerateButtonText('regenerate');
                    isGenerating = false;
                } else {
                    // Normal completion, render the site
                    currentGeneration.code = p5Code;
                    
                    // Execute HTML directly in the container
                    try {
                        const container = document.getElementById('generatedContent');
                        container.innerHTML = '';
                        
                        // Check if p5Code contains HTML tags (not just wrapped in script)
                        const isFullHTML = /<html[\s>]/i.test(p5Code) || /<body[\s>]/i.test(p5Code) || /<script[\s>]/i.test(p5Code) || /<style[\s>]/i.test(p5Code);
                        
                        if (isFullHTML) {
                            // For full HTML, create an iframe to isolate it
                            const iframe = document.createElement('iframe');
                            iframe.style.width = '100%';
                            iframe.style.height = '100%';
                            iframe.style.border = 'none';
                            iframe.style.margin = '0';
                            iframe.style.padding = '0';
                            container.appendChild(iframe);
                            
                            // Write the full HTML to the iframe
                            iframe.contentDocument.open();
                            iframe.contentDocument.write(p5Code);
                            iframe.contentDocument.close();
                        } else {
                            // For partial code, inject as script
                            const script = document.createElement('script');
                            script.textContent = p5Code;
                            container.appendChild(script);
                        }
                    } catch (e) {
                        console.error('Execution error:', e);
                        const container = document.getElementById('generatedContent');
                        container.innerHTML = '<div style="padding: 40px;">Error: ' + e.message + '</div>';
                    }
                    
                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                        regenerateButton.disabled = false;
                        setRegenerateButtonText('regenerate');
                        updateSaveButtonState();
                        isGenerating = false;
                    }, 500);
                }

            } catch (error) {
                // Clear the interval on error
                stopConsoleCommands();
                if (loadingMessageInterval) {
                    clearInterval(loadingMessageInterval);
                    loadingMessageInterval = null;
                }

                console.error('Error generating website:', error);
                await typeConsoleCommand('Error: ' + error.message, 'error', 25);
                mainStatus.textContent = 'ERROR';
                currentMessage.textContent = error.message;
                regenerateButton.disabled = false;
                setRegenerateButtonText('regenerate');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const regenerateButton = document.getElementById('regenerateButton');
            const saveButton = document.getElementById('saveButton');
            const backButton = document.getElementById('backButton');
            const favoritesButton = document.getElementById('favoritesButton');
            const closeModal = document.getElementById('closeModal');
            const modal = document.getElementById('favoritesModal');
            const notification = document.getElementById('newSiteNotification');

            notification.addEventListener('click', () => {
                if (backgroundGeneration) {
                    // Save current view as previous if it has content
                    if (currentGeneration.theme && currentGeneration.persona && currentGeneration.code) {
                        previousGeneration = { ...currentGeneration };
                        document.getElementById('backButton').style.display = 'block';
                    }
                    
                    // Load the background generation
                    currentGeneration = { ...backgroundGeneration };
                    
                    // Render the new site
                    const container = document.getElementById('generatedContent');
                    container.innerHTML = '';
                    container.style.display = 'block';
                    
                    const isFullHTML = /<html[\s>]/i.test(currentGeneration.code) || /<body[\s>]/i.test(currentGeneration.code) || /<script[\s>]/i.test(currentGeneration.code) || /<style[\s>]/i.test(currentGeneration.code);
                    
                    if (isFullHTML) {
                        const iframe = document.createElement('iframe');
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.border = 'none';
                        iframe.style.margin = '0';
                        iframe.style.padding = '0';
                        iframe.style.display = 'block';
                        container.appendChild(iframe);

                        setTimeout(() => {
                            iframe.contentDocument.open();
                            iframe.contentDocument.write(currentGeneration.code);
                            iframe.contentDocument.close();
                        }, 0);
                    } else {
                        const script = document.createElement('script');
                        script.textContent = currentGeneration.code;
                        container.appendChild(script);
                    }
                    
                    // Hide notification and update UI
                    notification.style.display = 'none';
                    updateSaveButtonState();
                    backgroundGeneration = null;
                }
            });
            
            regenerateButton.addEventListener('click', generateWebsite);
            saveButton.addEventListener('click', saveFavorite);
            backButton.addEventListener('click', backToGeneratedSite);
            
            favoritesButton.addEventListener('click', () => {
                loadFavorites();
                modal.classList.add('show');
            });
            
            closeModal.addEventListener('click', () => {
                modal.classList.remove('show');
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Generate initial website
            generateWebsite();
        });
    </script>
</body>

</html>