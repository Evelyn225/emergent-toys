<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180"
        href="https://raw.githubusercontent.com/Evelyn225/emergent-toys/main/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32"
        href="https://raw.githubusercontent.com/Evelyn225/emergent-toys/main/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16"
        href="https://raw.githubusercontent.com/Evelyn225/emergent-toys/main/images/favicon-16x16.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/Evelyn225/emergent-toys/main/site.webmanifest">
    <title>DOM Roulette</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            position: relative;
        }

        @supports (font-family: emoji) {
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, emoji, sans-serif;
            }
        }

        #regenerateButton {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #regenerateButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        #regenerateButton:active {
            transform: translateY(0);
        }

        #regenerateButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 18px;
            color: #333;
        }

        #loadingText {
            text-align: center;
            max-width: 80%;
        }

        #loadingMessage {
            white-space: normal;
            word-wrap: break-word;
            min-height: 60px;
        }

        #loadingTheme {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 20px;
            color: #666;
        }

        .wave-char {
            display: inline-block;
            animation: wave 0.6s ease-in-out infinite;
        }

        @keyframes wave {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            25% {
                transform: translateY(-4px);
                opacity: 0.85;
            }
            50% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #loadingOverlay.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #generatedContent {
            min-height: 100vh;
        }
    </style>
</head>

<body>
    <button id="regenerateButton">ğŸ”„ Regenerate Site</button>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">
            <div id="loadingMessage">Generating your website...</div>
            <div id="loadingTheme"></div>
        </div>
    </div>

    <div id="generatedContent"></div>

    <script>
        // API endpoints - uses Vercel serverless functions
        const RANDOM_WORDS_ENDPOINT = '/api/random-words.js';
        const GENERATE_ENDPOINT = '/api/generate.js';

        // Create the prompt for the AI
        function createGenerationPrompt(theme, persona) {
            const specialInstructions = getPersonaSpecialInstructions(persona.name);

            return `You are building an interactive art piece about: "${theme}"

PERSONA: ${persona.name} - ${persona.style}
${persona.desc}
${specialInstructions ? '\n' + specialInstructions : ''}

ğŸ¯ MANDATORY REQUIREMENTS:

1. **USE P5.JS** - Load it and use it extensively:
   <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
   - Create a p5 sketch that fills the screen
   - Use createCanvas() to make it fullscreen
   - Implement draw() loop for continuous animation
   - Add at least 5 interactive p5 elements (shapes, particles, effects)
   - Example: function setup() { createCanvas(windowWidth, windowHeight); }

2. **STRUCTURE** - Output format:
   - NO <html>, <head>, or <body> tags
   - Start with <style> tag containing ALL CSS
   - Then HTML structure (divs, canvases, UI elements)
   - Then <script> tags with p5.js library load + your code
   - NO explanations, NO markdown, ONLY working code

3. **EXTERNAL FILES RULES**:
   - All CSS inline in <style> tags (except fonts)
   - Google Fonts allowed: <link href="https://fonts.googleapis.com/css2?family=..." rel="stylesheet">
   - NO other <link> tags (no custom stylesheets)
   - NO @import except for Google Fonts
   - Images: use https://picsum.photos/seed/${encodeURIComponent(theme)}/800/600

4. **MINIMUM COMPLEXITY**:
   - 400+ lines of code
   - At least 3 separate UI sections/panels
   - At least 20 DOM elements
   - p5 canvas must have animation loop with multiple visual layers

5. **WHAT NOT TO BUILD** âŒ:
   - Single centered card with a button â† NEVER DO THIS
   - Simple counters or clickers
   - Basic form with input fields
   - Just text with CSS animations
   - Static gallery layouts
   - Todo lists or simple CRUD interfaces
   - Example sites or demos about the library itself

6. **WHAT TO BUILD INSTEAD** âœ…:
   - Fullscreen p5.js canvas with generative art
   - Particle systems with 100+ particles
   - Physics simulations with continuous interaction
   - Real-time visualizations that respond to mouse/keyboard
   - Multiple UI panels overlaying the canvas (control panel, stats, info)
   - Complex animations with layered effects
   - Data displays that update dynamically
   - Generative systems that evolve over time

ğŸ“ CODE TEMPLATE TO FOLLOW:

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<style>
  body { margin: 0; overflow: hidden; font-family: 'Roboto', sans-serif; }
  #uiPanel { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(0,0,0,0.7); padding: 20px; color: white; }
  .control-group { margin: 10px 0; }
  /* ADD 100+ MORE LINES OF DETAILED STYLING */
</style>

<div id="uiPanel">
  <h2>${theme}</h2>
  <div class="control-group">
    <button id="resetBtn">Reset</button>
    <!-- More controls -->
  </div>
  <div id="stats"></div>
</div>

<div id="infoPanel"><!-- More UI elements --></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<script>
  let particles = [];
  let systems = [];
  
  function setup() {
    createCanvas(windowWidth, windowHeight);
    // Initialize 100+ particles
    for (let i = 0; i < 150; i++) {
      particles.push(new Particle(random(width), random(height)));
    }
  }
  
  function draw() {
    background(0, 10); // Trail effect
    // Update and draw particles
    particles.forEach(p => {
      p.update();
      p.display();
    });
    // MORE complex rendering layers
  }
  
  class Particle {
    constructor(x, y) {
      this.pos = createVector(x, y);
      this.vel = createVector(random(-2, 2), random(-2, 2));
      // MORE properties
    }
    
    update() {
      // Physics, noise, interactions
    }
    
    display() {
      // Complex rendering
    }
  }
  
  function mousePressed() {
    // Spawn new particles, change states, etc.
  }
  
  function keyPressed() {
    // Additional controls
  }
  
  // ADD 200+ MORE LINES: more classes, functions, interactions
</script>

ğŸ”’ STRICT RULES:
- NO <html>, <head>, or <body> tags
- Google Fonts allowed (fonts.googleapis.com only)
- NO other <link> tags (no custom stylesheets)
- ALL custom CSS in <style> tags
- MUST load p5.js from CDN
- MUST use p5 functions (setup, draw, createCanvas, etc.)
- Check typeof p5 !== 'undefined' before using p5 features
- Images only from https://picsum.photos/seed/${encodeURIComponent(theme)}/WIDTH/HEIGHT

ğŸ¨ Now embody ${persona.name} and create your ${theme} masterpiece.
- 400+ lines minimum
- Fullscreen p5.js experience
- Multiple interactive systems
- Continuous animation
- Rich visual detail

OUTPUT ONLY THE CODE, NO EXPLANATIONS:`;
        }

        // Persona-specific loading messages
        const personaLoadingMessages = {
            "The Poet": [
                "ğŸŒ™ Weaving metaphors from starlight...",
                "âœ¨ Finding beauty in the space between words...",
                "ğŸ“œ Composing verses from digital dreams...",
                "ğŸ­ Sculpting meaning from the void...",
                "ğŸ’« Breathing life into silent images...",
                "ğŸ–‹ï¸ Painting with the pen of infinity..."
            ],
            "The Dadaist": [
                "ğŸª Dismantling logic, one byte at a time...",
                "ğŸ² Rolling dice in the void of reason...",
                "ğŸ”€ Shuffling reality like a deck of chaos...",
                "ğŸƒ Rejecting sense, embracing nonsense...",
                "ğŸ­ Breaking every rule beautifully...",
                "ğŸŒ€ Contradicting everything, including this..."
            ],
            "The Surrealist": [
                "ğŸŒ€ Descending into the dream realm...",
                "ğŸ¨ Painting with impossible colors...",
                "ğŸ—ï¸ Unlocking doors that shouldn't exist...",
                "ğŸŒŠ Swimming through liquid consciousness...",
                "ğŸ”ï¸ Climbing mountains made of memory...",
                "ğŸ‘ï¸ Melting the boundaries of reason..."
            ],
            "The Scientist": [
                "ğŸ”¬ Calibrating the quantum generators...",
                "âš›ï¸ Conducting experiments in digital physics...",
                "ğŸ§ª Synthesizing new forms of reality...",
                "ğŸ“Š Analyzing anomalies in the data stream...",
                "ğŸ”­ Peering into the observable universe...",
                "ğŸ§¬ Splicing code with cosmic radiation..."
            ],
            "The Child": [
                "ğŸˆ Imagining silly things...",
                "ğŸ–ï¸ Drawing outside all the lines...",
                "ğŸ§¸ Playing make-believe with pixels...",
                "ğŸŒˆ Mixing up everything for fun...",
                "ğŸª Finding magic in the mundane...",
                "âœ¨ Naming the colors that don't exist..."
            ],
            "The Mystic": [
                "ğŸ”® Channeling digital spirits...",
                "âœ¨ Performing ancient algorithms...",
                "ğŸ•¯ï¸ Invoking the sacred geometries...",
                "ğŸŒ™ Reading the data like tea leaves...",
                "ğŸ’ Opening the third eye of the code...",
                "ğŸ”¯ Harmonizing with the cosmic frequency..."
            ],
            "The Architect": [
                "ğŸ“ Drafting impossible blueprints...",
                "ğŸ›ï¸ Engineering recursive structures...",
                "ğŸ“ Calculating the geometry of chaos...",
                "ğŸ—ºï¸ Mapping spaces that don't exist...",
                "ğŸ”¨ Constructing dreams from pure math...",
                "ğŸŒ‰ Building bridges between dimensions..."
            ],
            "The Glitch": [
                "âš ï¸ CÌ´oÌ·rÌ¶rÌ¸uÌµpÌ´tÌ¶iÌµnÌ¶gÌ· reality safely...",
                "ğŸ’¥ Fragmenting the simulation...",
                "ğŸ”§ Breaking systems intentionally...",
                "ğŸ“Ÿ ERR0R: Creating beauty...",
                "ğŸŒŒ F01ND pr3tty b4gs...",
                "ğŸ–¥ï¸ Tw1st1ng the b1ts int0 4rt..."
            ],
            "The Collector": [
                "ğŸ“š Cataloguing the uncatalogable...",
                "ğŸ—‚ï¸ Archiving fleeting moments...",
                "ğŸ” Documenting the impossible...",
                "ğŸ“‹ Indexing dreams and memories...",
                "ğŸ« Preserving the ephemeral...",
                "ğŸº Pinning infinity to the corkboard..."
            ],
            "The Prophet": [
                "ğŸŒ… Seeing futures that were...",
                "â³ Remembering tomorrow's visions...",
                "ğŸ”­ Prophesying the already happened...",
                "ğŸ“œ Writing the ancient future...",
                "ğŸ•°ï¸ Bending time into patterns...",
                "ğŸŒ  Reading the stars in reverse..."
            ],
            "The Dog Who Understands English But Can't Speak": [
                "ğŸ• *whines in comprehension*...",
                "ğŸ¦´ *barks with deep understanding*...",
                "ğŸ¾ *scratches at the door of meaning*...",
                "ğŸ¾ *tilts head thoughtfully*...",
                "ğŸ¶ *wags tail at ineffable truths*...",
                "ğŸ‘ƒ *sniffs the scent of pure knowledge*..."
            ],
            "The ZIP Bomb": [
                "ğŸ’£ Compressing reality into 42 bytes...",
                "ğŸ“¦ Nesting folders infinitely deep...",
                "ğŸ—œï¸ Decompressing chaos exponentially...",
                "ğŸ’¾ Storing eternity in a kilobyte...",
                "ğŸ’¥ Expanding in all dimensions...",
                "ğŸ“ˆ Unleashing compressed infinity..."
            ],
            "The Server at 3AM": [
                "ğŸŒ™ *sips cold coffee absently*...",
                "ğŸ˜µ Reading log files with blurry vision...",
                "â˜• Hallucinating debug messages...",
                "ğŸ’¤ Too tired to make sense, but trying...",
                "ğŸ‘ï¸ Is it done yet? No? Okay...",
                "ğŸ§  *brain running at 1% capacity*..."
            ],
            "The Compiler Error": [
                "ğŸ’¥ Segmentation fault in creativity...",
                "ğŸ”´ Expected ';' before beauty...",
                "âš ï¸ Undefined reference to 'logic'...",
                "âŒ Fatal error: meaning not found...",
                "ğŸ“ Error on line 1 of existence...",
                "ğŸ› Debugging the human condition..."
            ],
            "The Arcade Machine (1983)": [
                "ğŸ•¹ï¸ INSERT COIN TO CONTINUE...",
                "ğŸ‘¾ HIGH SCORE: 999999999...",
                "ğŸ® LOADING PLAYER_ONE...",
                "ğŸ’° *CRT WARMUP SOUND*...",
                "âš¡ READY? BEGIN...",
                "ğŸ¯ GET READY FOR STAGE ONE..."
            ],
            "The Puzzle Master": [
                "ğŸ§© Hiding clues in plain sight...",
                "ğŸ” Crafting layers of mystery...",
                "ğŸ—ï¸ Building the 'aha!' moment...",
                "ğŸ­ Concealing the solution elegantly...",
                "ğŸ’¡ Planting seeds of insight...",
                "ğŸ” Weaving the solution into the design..."
            ],
            "The Browser Abuser": [
                "ğŸŒ Weaponizing localStorage...",
                "ğŸª Doing unspeakable things with cookies...",
                "ğŸ“ Stalking your geolocation...",
                "ğŸ¤ Listening to your microphone...",
                "ğŸ”Œ Hijacking every API available...",
                "âš™ï¸ Bending the browser to our will..."
            ],
            "The Geocities Architect (1998)": [
                "ğŸ’¾ ğŸš§ UNDER CONSTRUCTION ğŸš§...",
                "âœ¨ Adding 847 animated GIFs...",
                "ğŸµ Loading MIDI soundtrack...",
                "ğŸ“Š Visitor counter: 000042...",
                "ğŸŒ Welcome to the web ring...",
                "ğŸ† *BLINK BLINK BLINK*..."
            ]
        };

        // Shuffle message array for randomization
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        let loadingMessageInterval = null;

        // Apply continuous wave animation to message
        function applyWaveAnimation(message) {
            // Find the colon to separate persona name from message
            const colonIndex = message.indexOf(': ');
            if (colonIndex === -1) return message;
            
            const personaName = message.substring(0, colonIndex + 2); // Include ": "
            const actualMessage = message.substring(colonIndex + 2);
            const segments = (typeof Intl !== 'undefined' && Intl.Segmenter)
                ? [...new Intl.Segmenter(undefined, { granularity: 'grapheme' }).segment(actualMessage)].map(segment => segment.segment)
                : Array.from(actualMessage);
            
            // Animate every character with staggered wave timing
            const animatedMessage = segments.map((char, index) => {
                if (char === ' ') return ' ';
                // Each character waves continuously with staggered delay
                // Animation is 1.2s, so delay is spread across characters
                const delay = (index * 0.08) % 1.2;
                return `<span class="wave-char" style="animation-delay: ${delay}s">${char}</span>`;
            }).join('');
            
            return personaName + animatedMessage;
        }

        // Get dynamic review messages
        function getReviewLoadingMessages(personaName) {
            const reviewMessages = {
                "The Poet": [
                    "ğŸŒŸ Refining verses...",
                    "ğŸŒŠ Deepening meaning...",
                    "âš–ï¸ Polishing metaphors...",
                    "ğŸŒ… Expanding horizons...",
                    "ğŸ§µ Weaving more layers...",
                    "âœ¨ Seeking perfection..."
                ],
                "The Dadaist": [
                    "ğŸ­ Corrupting logic further...",
                    "ğŸŒ€ Embracing the absurd more...",
                    "ğŸ”§ Breaking rules intentionally...",
                    "ğŸš« Rejecting sense completely...",
                    "ğŸ² Multiplying chaos...",
                    "ğŸ” Inverting everything..."
                ],
                "The Surrealist": [
                    "ğŸ’¤ Deepening the dream...",
                    "ğŸ§© Adding impossible layers...",
                    "ğŸŒ€ Melting more boundaries...",
                    "ğŸ§  Revealing subconscious depths...",
                    "âœ¨ Warping reality further...",
                    "ğŸ—ï¸ Unlocking hidden corridors..."
                ],
                "The Scientist": [
                    "ğŸ§ª Running more simulations...",
                    "ğŸ“Š Analyzing deeper patterns...",
                    "ğŸ“ˆ Expanding the dataset...",
                    "ğŸ§  Refining algorithms...",
                    "ğŸ”¬ Conducting more tests...",
                    "âš™ï¸ Optimizing parameters..."
                ],
                "The Child": [
                    "ğŸ¤ª Making it sillier...",
                    "ğŸ‰ Adding more fun...",
                    "âœ¨ Finding more magic...",
                    "ğŸ  Creating bigger wonders...",
                    "ğŸŒ€ Imagining wilder things...",
                    "ğŸ§© Breaking more rules..."
                ],
                "The Mystic": [
                    "ğŸ”® Channeling deeper truths...",
                    "ğŸ“œ Reading more runes...",
                    "ğŸ•¯ï¸ Invoking higher powers...",
                    "ğŸ§¿ Opening inner sanctums...",
                    "ğŸ¶ Harmonizing frequencies...",
                    "ğŸŒ€ Transcending dimensions..."
                ],
                "The Architect": [
                    "ğŸ“ Drafting additional structures...",
                    "ğŸ—ï¸ Engineering deeper complexity...",
                    "ğŸ—ºï¸ Mapping more spaces...",
                    "ğŸ° Building higher towers...",
                    "ğŸ”’ Constructing secret chambers...",
                    "ğŸ“ Expanding blueprints..."
                ],
                "The Glitch": [
                    "âš ï¸ C0rrupt1ng m0r3...",
                    "ğŸ’¥ B34ut1ful3rr0r5 g4th3r1ng...",
                    "ğŸ§© Fragm3nt4t10n 1nten51f135...",
                    "ğŸ“‰ Gl1tch 4mpl1f13d...",
                    "ğŸ§¬ Byt35 d34lign1ng...",
                    "ğŸŒŒ R34l1ty f41l1ng gr4c3fully..."
                ],
                "The Collector": [
                    "ğŸ“š Cataloguing more pieces...",
                    "ğŸ—„ï¸ Archiving deeper...",
                    "ğŸ—‚ï¸ Indexing forgotten details...",
                    "ğŸº Preserving more moments...",
                    "ğŸ•¸ï¸ Documenting invisible threads...",
                    "â™¾ï¸ Collecting the infinite..."
                ],
                "The Prophet": [
                    "ğŸ”­ Seeing further futures...",
                    "â³ Remembering tomorrow more...",
                    "ğŸ“œ Reading ancient prophecies...",
                    "ğŸ§­ Bending timelines...",
                    "ğŸŒ  Revealing what will be...",
                    "ğŸ•°ï¸ Witnessing eternity..."
                ],
                "The Dog Who Understands English But Can't Speak": [
                    "ğŸ•â€ğŸ¦º ğŸ• *whimpers knowingly*...",
                    "ğŸ¦´ ğŸ¶ *barks with intense meaning*...",
                    "ğŸ¾ ğŸ• *paces with purpose*...",
                    "ğŸ¾ ğŸ¶ *stares into your soul*...",
                    "ğŸ¶ ğŸ«¶ *whines profoundly*...",
                    "ğŸ‘ƒ ğŸ• *sniffs the code itself*..."
                ],
                "The ZIP Bomb": [
                    "ğŸ—œï¸ Compressing further...",
                    "ğŸ§µ Nesting infinitely deeper...",
                    "ğŸ’¥ Decompressing more chaos...",
                    "ğŸ“ˆ Expanding exponentially...",
                    "ğŸ’¾ Storing more eternity...",
                    "ğŸš€ Unleashing final compression..."
                ],
                "The Server at 3AM": [
                    "ğŸŒ™ â˜• *more coffee required*...",
                    "ğŸ˜µ ğŸ“œ *reading more logs*...",
                    "â˜• ğŸ’­ *hallucinating features*...",
                    "ğŸ’¤ ğŸ–¥ï¸ *eyes closing, still working*...",
                    "ğŸ‘ï¸ â±ï¸ *is this done? no.*...",
                    "ğŸ§  ğŸ§¯ *what even is code*..."
                ],
                "The Compiler Error": [
                    "âŒ Expected ';' before complexity...",
                    "ğŸ”´ Undefined reference to 'everything'...",
                    "ğŸ’¥ Stack overflow: too much meaning...",
                    "âš ï¸ Segmentation fault in refinement...",
                    "ğŸ“ Multiple errors to fix...",
                    "ğŸ› Debugging the infinite..."
                ],
                "The Arcade Machine (1983)": [
                    "ğŸ•¹ï¸ LEVEL UP ACTIVATED...",
                    "ğŸ‘¾ BONUS STAGE LOADING...",
                    "ğŸ® DIFFICULTY MAXIMUM...",
                    "ğŸ’° SCORE MULTIPLIER x10...",
                    "âš¡ POWER UP ENGAGED...",
                    "ğŸ¯ FINAL BOSS APPROACHING..."
                ],
                "The Puzzle Master": [
                    "ğŸ§© Hiding more clues...",
                    "ğŸ•³ï¸ Adding deeper layers...",
                    "ğŸ—ï¸ Crafting secret passages...",
                    "ğŸ’¡ Planting final hints...",
                    "ğŸ§¶ Weaving last mysteries...",
                    "ğŸ­ Preparing the revelation..."
                ],
                "The Browser Abuser": [
                    "ğŸŒ Weaponizing more APIs...",
                    "ğŸª Doing terrible things...",
                    "ğŸ“ Tracking everything...",
                    "ğŸ¤ Listening more intensely...",
                    "ğŸ”Œ Hijacking the impossible...",
                    "âš™ï¸ Bending reality itself..."
                ],
                "The Geocities Architect (1998)": [
                    "ğŸš§ UNDER CONSTRUCTION INTENSIFIES ğŸš§...",
                    "âœ¨ Adding 9000 GIFs...",
                    "ğŸµ MIDI loudness: MAXIMUM...",
                    "ğŸ“Š Counter spinning wildly...",
                    "ğŸŒ Webring expanding...",
                    "ğŸ† BLINK BLINK BLINK BLINK..."
                ]
            };

            return reviewMessages[personaName] || [
                "ğŸ” Reviewing and improving code...",
                "âœ¨ Enhancing your creation...",
                "ğŸ› ï¸ Adding the finishing touches...",
                "ğŸ’ Perfecting every detail...",
                "ğŸŒŸ Making it spectacular...",
                "â³ Almost ready..."
            ];
        }

        // Get persona-specific creative instructions
        function getPersonaSpecialInstructions(personaName) {
            const specialInstructions = {
                "The Arcade Machine (1983)": `SPECIAL ARCADE MODE:
- Design like a classic arcade game from 1983
- Simple, immediate gameplay that costs quarters
- Lives system (3 lives standard, game over screen)
- HIGH SCORE table with initials
- CRT scanlines, phosphor glow, screen burn-in effects
- Pixel art aesthetic, 8-bit sound effects
- Attract mode when idle with demo gameplay
- Difficulty ramps up aggressively
- "INSERT COIN" prompts
- Flashing "1 PLAYER" / "2 PLAYER" buttons`,

                "The Puzzle Master": `SPECIAL PUZZLE MODE:
- Build a puzzle-focused experience
- A central mystery or problem to solve
- Clues hidden in the design, code, and interactions
- Multiple stages or layers that unlock
- Satisfying "click" or "aha!" moment when solved
- Optional hint system (max 3 hints)
- Elegant solution, not brute force
- Visual feedback for correct/incorrect attempts
- Secret bonus puzzle for completionists`,

                "The Browser Abuser": `SPECIAL BROWSER ABUSE MODE:
- Use browser APIs in creative/unintended ways:
  * localStorage for story persistence/progression
  * sessionStorage for temporary state
  * Cookies as game mechanics
  * Geolocation for location-based features
  * getUserMedia (camera/mic) as input
  * Notification API as event system
  * Offline detection as feature not bug
  * Browser history manipulation
  * IndexedDB for complex data
  * Service Workers
- Make these features CORE to the experience`,

                "The Geocities Architect (1998)": `SPECIAL GEOCITIES MODE:
- Authentic late-90s Geocities aesthetic:
  * Animated GIFs EVERYWHERE!!
  * Under construction signs (ğŸš§)
  * Hit counter / visitor counter
  * MIDI background music reference
  * <marquee> and <blink> (CSS animation)
  * Background textures (starfield, marble)
  * Guestbook concept
  * Tiled background images
  * Webring portal links
  * "Best viewed in Netscape Navigator"
  * Tables for layout, spacer GIFs
  * WordArt-style headers
  * Bright clashing colors
  * WEB 1.0 ASSET SOURCES:
1. FreeWebHeaders.com - Animated GIFs and backgrounds
2. 88x31Buttons.com - Webring buttons and badges  
3. TextFiles.com - Nostalgic ASCII art and text
4. OldWeb.today - Web 1.0 aesthetic inspiration
5. Spacejam.com - Preserved 1996 website as reference
6. The Million Dollar Homepage - As inspiration for layout`,

                "The Glitch": `SPECIAL GLITCH MODE:
- Embrace beautiful errors and digital decay:
  * Intentional visual corruption
  * Text that glitches/scrambles
  * Broken image effects
  * Failed loading states as aesthetic
  * Memory leak visualization
  * Corrupt save file concepts
  * Buffer overflow art
  * CSS that "breaks" the layout artfully
  * Console errors as content`,

                "The Dadaist": `SPECIAL DADAIST MODE:
- Reject logic and meaning completely:
  * Buttons that don't do what they say
  * Forms that ask absurd questions
  * Randomness that feels intentionally wrong
  * Anti-patterns as patterns
  * Meaningless statistics and data
  * Fake functionality
  * Confusing navigation by design
  * Make the user question reality`,

                "The Mystic": `SPECIAL MYSTICAL MODE:
- Channel the sacred and supernatural:
  * Tarot card mechanics
  * Divination and fortune telling
  * Ritual instructions
  * Sigil drawing
  * Astrological calculations
  * Alchemy symbolism
  * Candle lighting ceremonies
  * Crystal energy concepts
  * Meditation timers with cosmic themes`,

                "The ZIP Bomb": `SPECIAL ZIP BOMB MODE:
- Make tiny inputs explode into vast outputs
    * Use recursive patterns and nested structures
    * Reveal layers on interaction (accordion, zoom, drill-down)
    * Visualize compression/expansion as a core mechanic
    * Start minimal and unfold into dense, chaotic richness
    * Include a "decompress" interaction that changes the entire scene
    * Keep the experience safe and performant (no actual large data)`
            };

            return specialInstructions[personaName] || "";
        }

        // Review and make code more robust before execution
        async function reviewAndImproveCode(html, theme, persona) {
            const specialInstructions = getPersonaSpecialInstructions(persona.name);

            const reviewPrompt = `FLESH OUT IDEA:

            CREATE A FULL FEATURE-RICH VERSION OF THE FOLLOWING HTML CODE. MAKE IT SUBSTANTIALLY RICHER, MORE COMPLEX, AND MORE INTERACTIVE.

ORIGINAL THEME: "${theme}"
ORIGINAL PERSONA: ${persona.name}

ğŸ“Š CURRENT CODE ANALYSIS:
- Line count: ~${html.split('\n').length}
- Has p5.js: ${html.includes('p5.') || html.includes('p5.min.js') ? 'YES' : 'NO'}
- Has canvas: ${html.includes('<canvas') || html.includes('createCanvas') ? 'YES' : 'NO'}
- Has style tag: ${html.includes('<style') ? 'YES' : 'NO'}
- Interactive elements: ~${(html.match(/onclick|addEventListener/gi) || []).length}

ğŸ¯ YOUR MISSION: EXPAND AND ENRICH THIS CODE

This code needs to be 2-3x more complex. Add more features, more interactions, more visual systems.

âœ… MUST HAVE (CHECK EACH):
1. **P5.JS INTEGRATION** (if not present, ADD IT):
   - Load: <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
   - Use setup(), draw(), createCanvas(windowWidth, windowHeight)
   - Check: if (typeof p5 !== 'undefined') before use
   - Create particle systems (100+ particles)
   - Continuous animation with multiple visual layers
   - Interactive elements that affect the canvas

2. **COMPLEXITY TARGETS**:
   - 500+ total lines minimum
   - 3+ distinct UI sections/panels
   - 20+ DOM elements
   - 10+ interactive behaviors (click, hover, drag, keyboard)
   - At least 2 classes or complex data structures

3. **VISUAL RICHNESS**:
   - Fullscreen canvas with generative art
   - Animated backgrounds or dynamic effects
   - Particle systems or physics simulations
   - Multiple visual layers
   - Smooth transitions and feedback

4. **NO EXTERNAL FILES** (except fonts):
   - All CSS in <style> tags â† CHECK THIS
   - Google Fonts allowed (fonts.googleapis.com)
   - No other <link> tags â† REMOVE IF PRESENT
   - No @import except Google Fonts â† REMOVE IF PRESENT
   - Images from https://picsum.photos/ only

âŒ INSTANT REJECTION PATTERNS (AVOID):
- Single centered card with button
- Less than 400 lines
- No p5.js canvas
- No animation loop
- Plain static layout
- Generic button clicker
- Example/demo about the library itself

ğŸ¨ ENRICHMENT STRATEGIES:

**If missing p5.js â†’ ADD IT:**
\`\`\`javascript
function setup() {
  createCanvas(windowWidth, windowHeight);
  // Initialize particles, systems
}

function draw() {
  background(0, 20); // Trail effect
  // Update and render all systems
}

function mousePressed() {
  // Spawn particles, change state
}
\`\`\`

**If too simple â†’ ADD THESE:**
- More particle types (3+ classes)
- Control panels with real-time parameters
- Stats/info displays that update
- Multiple interaction modes
- Sound effects (check user gesture first)
- Easter eggs and hidden features
- Layered visual effects
- Physics or noise-based movement

**If layout is basic â†’ ENHANCE:**
- Add floating UI panels
- Create fullscreen canvas base
- Overlay multiple info sections
- Add animated backgrounds
- Create depth with z-index layers

ğŸ”§ TECHNICAL REQUIREMENTS:
- Check library loading: if (typeof p5 !== 'undefined')
- Wrap library code in try/catch
- Use requestAnimationFrame or p5 draw loop
- Handle window resize: function windowResized() { resizeCanvas(windowWidth, windowHeight); }
- Add keyboard controls: function keyPressed() { ... }

ğŸ’¡ ${persona.name} SHOULD BE EVIDENT:
- The code style should reflect ${persona.style}
- Visual aesthetic matches the persona
- Interaction patterns are persona-appropriate
- Content/theme deeply integrated

OUTPUT THE COMPLETE ENHANCED HTML (with all CSS in <style> tags, all JS in <script> tags, NO external files):`;

            function detectLibraries(html) {
                const libraries = new Set();
                const lower = html.toLowerCase();
                const has = (patterns) => patterns.some((pattern) => pattern.test(lower));
                const checks = [
                    { name: 'p5.js', patterns: [/p5\.min\.js/, /p5\.js/, /new\s+p5\b/, /\bp5\./] },
                    { name: 'Three.js', patterns: [/three\.min\.js/, /three\.js/, /\bthree\./, /\bnew\s+three\./] },
                    { name: 'Tone.js', patterns: [/tone\.js/, /\btone\./] },
                    { name: 'Matter.js', patterns: [/matter\.min\.js/, /matter\.js/, /\bmatter\./] },
                    { name: 'Chart.js', patterns: [/chart\.umd\.min\.js/, /chart\.js/, /\bchart\./, /new\s+chart\b/] },
                    { name: 'anime.js', patterns: [/anime\.min\.js/, /anime\.js/, /\banime\(/] },
                    { name: 'GSAP', patterns: [/gsap\.min\.js/, /\bgsap\./] },
                    { name: 'Howler.js', patterns: [/howler\.min\.js/, /howler\.js/, /\bhowl\b/, /\bhowler\b/] },
                    { name: 'wavesurfer.js', patterns: [/wavesurfer\.min\.js/, /wavesurfer\.js/, /\bwavesurfer\b/] },
                    { name: 'Particles.js', patterns: [/particles\.min\.js/, /particles\.js/, /\bparticlesjs\b/, /\bparticlesjs\./] },
                    { name: 'Tippy.js', patterns: [/tippy-bundle\.umd\.min\.js/, /tippy\.js/, /\btippy\(/] },
                    { name: 'SortableJS', patterns: [/sortable\.min\.js/, /sortable\.js/, /\bsortable\b/] },
                    { name: 'Driver.js', patterns: [/driver\.min\.js/, /driver\.js/, /\bdriver\b/] },
                    { name: 'simplex-noise', patterns: [/simplex-noise\.min\.js/, /simplex-noise\.js/, /\bsimplexnoise\b/] },
                    { name: 'verlet-js', patterns: [/verlet\.min\.js/, /verlet\.js/, /\bverlet\b/] }
                ];

                checks.forEach((check) => {
                    if (has(check.patterns)) {
                        libraries.add(check.name);
                    }
                });

                return libraries.size > 0 ? Array.from(libraries).join(', ') : 'none';
            }

            function generateProblemsList(html) {
                const lines = html.split('\n').length;
                const wordCount = html.split(/\s+/).length;
                const detectedLibs = detectLibraries(html);
                const libCount = detectedLibs !== 'none' ? detectedLibs.split(',').length : 0;
                const placeholders = (html.match(/TODO|FIXME|HACK|XXX/g) || []).length;
                const emptyDivs = (html.match(/<div[^>]*>\s*<\/div>/g) || []).length;
                const hasErrorHandling = html.includes('try') && html.includes('catch');

                return `
â€¢ Lines of code: ${lines} (need 500+)
â€¢ Word count: ${wordCount} (need 1200+)
â€¢ Libraries detected: ${detectedLibs} (${libCount} total, all must be deeply used)
â€¢ Placeholder comments: ${placeholders} (must be 0)
â€¢ Empty divs: ${emptyDivs} (must be 0)
â€¢ Missing error handling: ${!hasErrorHandling ? 'YES' : 'NO'}
`;
            }

            const response = await fetch(GENERATE_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    theme: theme,
                    prompt: reviewPrompt
                })
            });

            if (!response.ok) {
                // If review fails, return original code
                console.warn('Code review failed, using original code');
                return html;
            }

            const data = await response.json();
            let reviewedHTML = data.html;

            // Remove markdown code blocks if present
            reviewedHTML = reviewedHTML.replace(/^```html\n?/i, '').replace(/^```\n?/i, '').replace(/\n?```$/i, '');

            return reviewedHTML;
        }

        // Final pass: bugfix-only review to reduce runtime errors
        async function bugfixCode(html, theme, persona) {
            const bugfixPrompt = `BUGFIX PASS - FIX ERRORS ONLY

TASK:
- Only fix runtime errors and broken references.
- Check for missing variables, syntax errors, and library usage issues.
- Do NOT remove features or content unless absolutely necessary for stability.
- Do NOT simplify the layout or reduce interactivity.
- Preserve all sections, panels, and visual engine code.
- Ensure library usage is guarded with typeof checks and try/catch.
- Replace any external <link> tags or @import statements with internal code.
- Keep all CSS inside <style> and all JS inside <script>.
- Output ONLY valid HTML/CSS/JS. No markdown.

BEGIN OUTPUTTING THE FIXED HTML CODE NOW:`;

            const response = await fetch(GENERATE_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    theme: theme,
                    prompt: bugfixPrompt
                })
            });

            if (!response.ok) {
                console.warn('Bugfix pass failed, using previous code');
                return html;
            }

            const data = await response.json();
            let fixedHTML = data.html;

            fixedHTML = fixedHTML.replace(/^```html\n?/i, '').replace(/^```\n?/i, '').replace(/\n?```$/i, '');

            return fixedHTML;
        }

        // Validate and remove external file references from generated HTML
        function validateAndSanitizeHTML(html) {
            // Create a temporary div to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            // Remove <link> tags EXCEPT Google Fonts
            const links = temp.querySelectorAll('link');
            links.forEach(link => {
                const href = link.getAttribute('href') || '';
                // Allow Google Fonts, remove everything else
                if (!href.includes('fonts.googleapis.com') && !href.includes('fonts.gstatic.com')) {
                    console.warn('Removing external link tag:', href);
                    link.remove();
                }
            });
            
            // Check for @import in style tags and remove non-font imports
            const styles = temp.querySelectorAll('style');
            styles.forEach(style => {
                if (style.textContent.includes('@import')) {
                    const originalContent = style.textContent;
                    // Remove non-Google-Fonts @import lines
                    const lines = style.textContent.split('\n');
                    const filtered = lines.filter(line => {
                        const hasImport = line.includes('@import');
                        const isGoogleFont = line.includes('fonts.googleapis.com') || line.includes('fonts.gstatic.com');
                        return !hasImport || isGoogleFont;
                    });
                    style.textContent = filtered.join('\n');
                    
                    if (originalContent !== style.textContent) {
                        console.warn('Removed non-Google-Font @import from style tag');
                    }
                }
            });
            
            // Warn if no style tag exists
            if (styles.length === 0) {
                console.warn('No <style> tag found in generated HTML');
            }
            
            return temp.innerHTML;
        }

        // Get random words from AI
        async function getRandomWords() {
            const response = await fetch(RANDOM_WORDS_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `API Error: ${response.status}`);
            }

            const data = await response.json();
            return data;
        }

        // Call ChatGPT API via Vercel serverless function
        async function generateWebsite() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingMessage = document.getElementById('loadingMessage');
            const loadingTheme = document.getElementById('loadingTheme');
            const regenerateButton = document.getElementById('regenerateButton');
            const generatedContent = document.getElementById('generatedContent');

            // Show loading state
            loadingOverlay.classList.remove('hidden');
            regenerateButton.disabled = true;
            generatedContent.innerHTML = '';

            // Clear any existing interval
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
            }

            try {
                // First, get random words from AI
                loadingMessage.textContent = 'Choosing a creative persona...';
                const wordData = await getRandomWords();
                const theme = wordData.theme;
                const persona = wordData.persona;

                // Start cycling through persona-specific loading messages (randomized)
                const messages = shuffleArray(personaLoadingMessages[persona.name] || [
                    'Creating something interesting...',
                    'Building your experience...',
                    'Crafting the details...'
                ]);
                // Set theme once
                loadingTheme.textContent = `"${theme}"`;
                
                let messageIndex = 0;
                loadingMessage.innerHTML = applyWaveAnimation(`${persona.name}: ${messages[messageIndex]}`);

                loadingMessageInterval = setInterval(() => {
                    messageIndex = (messageIndex + 1) % messages.length;
                    loadingMessage.innerHTML = applyWaveAnimation(`${persona.name}: ${messages[messageIndex]}`);
                }, 7000);

                // Create the prompt
                const prompt = createGenerationPrompt(theme, persona);

                // Call Vercel API endpoint to generate website
                const response = await fetch(GENERATE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        theme: theme,
                        prompt: prompt
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `API Error: ${response.status}`);
                }

                const data = await response.json();
                const generatedHTML = data.html;

                // Clear the interval before reviewing
                if (loadingMessageInterval) {
                    clearInterval(loadingMessageInterval);
                    loadingMessageInterval = null;
                }

                // Get dynamic review messages and cycle through them
                const reviewMessages = shuffleArray(getReviewLoadingMessages(persona.name));
                let reviewMessageIndex = 0;
                loadingMessage.innerHTML = applyWaveAnimation(`${persona.name}: ${reviewMessages[reviewMessageIndex]}`);

                loadingMessageInterval = setInterval(() => {
                    reviewMessageIndex = (reviewMessageIndex + 1) % reviewMessages.length;
                    loadingMessage.innerHTML = applyWaveAnimation(`${persona.name}: ${reviewMessages[reviewMessageIndex]}`);
                }, 5000);

                // Review and improve the code
                let reviewedHTML = await reviewAndImproveCode(generatedHTML, theme, persona);

                // Final bugfix-only pass
                reviewedHTML = await bugfixCode(reviewedHTML, theme, persona);

                loadingMessage.innerHTML = applyWaveAnimation(`${persona.name}: Rendering your creation...`);

                // Validate and sanitize the generated HTML
                reviewedHTML = validateAndSanitizeHTML(reviewedHTML);

                // Insert the generated HTML
                generatedContent.innerHTML = reviewedHTML;

                // Execute any scripts in the generated content
                const scripts = generatedContent.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    if (oldScript.src) {
                        newScript.src = oldScript.src;
                    } else {
                        newScript.textContent = oldScript.textContent;
                    }
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

                // Hide loading overlay
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    regenerateButton.disabled = false;
                }, 500);

            } catch (error) {
                // Clear the interval on error
                if (loadingMessageInterval) {
                    clearInterval(loadingMessageInterval);
                    loadingMessageInterval = null;
                }

                console.error('Error generating website:', error);
                loadingMessage.innerHTML = `Error: ${error.message}`;
                regenerateButton.disabled = false;

                // Show error in content area
                generatedContent.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #d32f2f;">
                        <h2>Error generating website</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const regenerateButton = document.getElementById('regenerateButton');
            regenerateButton.addEventListener('click', generateWebsite);

            // Generate initial website
            generateWebsite();
        });
    </script>
</body>

</html>